<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.11"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>Forwarder XT28 API Documentation: Controllers</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="doxy-boot.js"></script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">Forwarder XT28 API Documentation 0.1.0</a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel panel-default" style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part --><!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Guides&#160;and&#160;Exampels</span></a></li>
      <li><a href="modules.html"><span>XT28&#160;API&#160;documentation</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Controllers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This page explains the different controllers available.</p>
<p>The purpose of Active dampening is three things</p>
<ul>
<li>Keep the machine leveled</li>
<li>Even out the group pressure.</li>
<li>Reduce vibrations</li>
</ul>
<p>It doesent exist one signel control type of strucke that can achinve all thease goals at the same time. What is done insteed is to use different controller with difference purpose that achinve alteast one of the problems and then superpossision the signals togheter and actuate on the wheels.</p>
<p>There is a PID controller for achinving leveling, and there is a PID controller for achiving even group pressure. Adding thease signals togheter is a way to achive the goal of active dampening.</p>
<h1>PID Controllers </h1>
<p>The PID controllers that are implemented exist for two different goals. There exist a controller that handels the leveling of the machine. There also exist an controller that atempt the wheel to follow a set force reference.</p>
<h2>PID leveling</h2>
<p>The PID leveling controllers input are the following</p>
<ul>
<li>Error height</li>
<li>Error pitch angle theta</li>
<li>Error roll angle phi</li>
</ul>
<p>Given thease error the controller then calculate a output with the standard formula for PID as</p>
<p><br />
 </p><p class="formulaDsp">
\begin{align} \tag{1} u_z &amp; = P_z e_z + I_z \int_0^t{e_z\delta t} + D_z\frac{d}{dt}e_z \\ \tag{2} u_{\varphi} &amp; = P_{\varphi} e_{\varphi} + I_{\varphi} \int_0^t{e_{\varphi}\delta t} + D_{\varphi}\frac{d}{dt}e_{\varphi} \\ \tag{3} u_{\theta} &amp; = P_{\theta} e_{\theta} + I_{\theta} \int_0^t{e_{\theta}\delta t} + D_z\frac{d}{dt}e_{\theta} \end{align}
</p>
<p> <br />
</p>
<p>After calculation the signals they are allocated to the wheels on the machine. The allocation of signals for the height PID controller is presented in a table below.</p>
<center> <b>Table 1: Height allocation constants</b> </center> <center> <table class="doxtable">
<tr>
<th>Position </th><th>Left </th><th>Right  </th></tr>
<tr>
<td>Front </td><td>0.16 </td><td>0.16 </td></tr>
<tr>
<td>Middle </td><td>0.16 </td><td>0.16 </td></tr>
<tr>
<td>Back </td><td>0.16 </td><td>0.16 </td></tr>
</table>
</center><p>What this means is that you calculate a signal from the height error and out you get a height signal output. To allocate it to all the wheels on the machine that output is scaled with an arbitrary number. In this case it derived from a pesudo matrix solution based on the equations of motions and geometry of the forwarder. Note that doing resaults in different constants for height controller. That becouse those constants are based on force.</p>
<p>The allocations constants for roll phi controller is seen in the table below.</p>
<center> <b>Table 2: Angle</b> \(\varphi\) <b>allocation constants</b> </center> <center> <table class="doxtable">
<tr>
<th>Constants </th><th>Left </th><th>Right  </th></tr>
<tr>
<td>Front </td><td>0.33 </td><td>-0.33 </td></tr>
<tr>
<td>Middle </td><td>0.33 </td><td>-0.33 </td></tr>
<tr>
<td>Back </td><td>0.33 </td><td>-0.33 </td></tr>
</table>
</center><p>This means that depending on a error in phi will result in that the wheels on the left side goes in one direction and on the right side goes opposite direction. Finaly the allocation constants for theta</p>
<center> <b>Table 3: Angle</b> \(\theta\) <b>allocation constants</b> </center> <center> <table class="doxtable">
<tr>
<th>Constants </th><th>Left </th><th>Right  </th></tr>
<tr>
<td>Front </td><td>0.12 </td><td>0.12 </td></tr>
<tr>
<td>Middle </td><td>-0.01 </td><td>-0.01 </td></tr>
<tr>
<td>Back </td><td>-0.12 </td><td>-0.12 </td></tr>
</table>
</center><p>This controller will level and only level the machine. It does not take force in condidiration in anyway. From this the final output signal can be shown as</p>
<p><br />
 </p><p class="formulaDsp">
\begin{equation} u_{out, i} = u_{z} \cdot K_{z, i} + u_{\varphi} \cdot K_{\varphi, i} + u_{\theta} \cdot K_{\theta, i} \tag{4} \end{equation}
</p>
<p> <br />
</p>
<p>Finaly lets summerize that the this controller can do</p>
<center> <b>Table 4: PID Niv achivments</b> </center> <center> <table class="doxtable">
<tr>
<th align="center">Active dampening Goals </th><th>PID leveling  </th></tr>
<tr>
<td align="center">Leveling </td><td>Yes </td></tr>
<tr>
<td align="center">Pressure distribution </td><td>No </td></tr>
<tr>
<td align="center">Reduce vibraions </td><td>debatable </td></tr>
</table>
</center><p>An example of how to use this function follows </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> PIDNivControl() {</div><div class="line"></div><div class="line">    <span class="comment">// Set parameters</span></div><div class="line">    <a class="code" href="group___a_d_p_i_d.html#ga7392f0345aeda777d72ee88870c1e998">ADPIDSetHeightControlParametersPID</a>(heightP, heightI, 0);</div><div class="line">    <a class="code" href="group___a_d_p_i_d.html#ga4253a7a1b9969c6f01a76194cac93154">ADPIDSetPhiControlParametersPID</a>   (phiP,    phiI,    0);</div><div class="line">    <a class="code" href="group___a_d_p_i_d.html#ga29402d1173719bd6290624ff09732f91">ADPIDSetThetaControlParametersPID</a> (thetaP,  thetaI,  0);</div><div class="line"></div><div class="line">    <span class="comment">// Get signal and put in array</span></div><div class="line">    <span class="keywordtype">float</span> referenceCurrentArray[SUM_WHEELS] = {0};</div><div class="line">    <a class="code" href="group___a_d_p_i_d.html#ga4d3accb835909e0128fcc9547542238a">ADPIDGetPIDSignalsForHeightPhiAndThetaArray</a>(referenceCurrentArray,  <span class="comment">// Output array</span></div><div class="line">            (heightReference - <a class="code" href="group___p_a_p_o_s.html#gabc123568a0f80fb769c0aa8f2d56e902">PAPOSGetAvrageHeightOfForwarder</a>()),      <span class="comment">// Error in Z</span></div><div class="line">            (phiReference    - <a class="code" href="group___i_m_u.html#ga8bd1e7cc0aaa4e830997f3ce15e69f70">IMUGetPhi</a>()),                            <span class="comment">// Error in Phi</span></div><div class="line">            (thetaReference  - <a class="code" href="group___i_m_u.html#ga07085c58811ef6b770502256ed01f46a">IMUGetTheta</a>())                           <span class="comment">// Error in Theta</span></div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="comment">// Set reference current and actuate</span></div><div class="line">    <a class="code" href="group___p_a_a.html#ga6400604a60cd44b32d626e548e5c36e6">PAASetReferenceArrayWithUnit</a>(referenceCurrentArray, <a class="code" href="group___p_a_a.html#gga15da6807954393e1942ff382b518cc46a9fcb1c26ff07c0422931d11a5386e934">CURRENT_MA</a>);</div><div class="line">    <a class="code" href="group___p_a_a.html#gae685f50177dba1ae770661eb69bf96cb">PAAActuatePendelumArms</a>();</div><div class="line">}</div></div><!-- fragment --><p> This set of code will level the machine. The API interface for PID leveling is found at <a class="el" href="group___a_d_p_i_d.html">PID</a>.</p>
<h2>PID force wheel</h2>
<p>There is an implemented controller for controlling a wheel with to follow a reference force. For this system finding a reference for wheel is the hard problem. The <a class="el" href="group___p_a_f.html">Forces</a> module calculates a suggested force. So the use of this controller is easy, give it an error and you get a signal back. This controller only purpose in life is to give you a signal that makes the wheels error force go to zero. it does not take leveling into account in any way.</p>
<p>In summery this sort of controller given that its possibole to calculate a force reference for all wheels:</p>
<center> <b>Table 5: PID Force</b> </center> <center> <table class="doxtable">
<tr>
<th align="center">Active dampening Goals </th><th>PID leveling  </th></tr>
<tr>
<td align="center">Leveling </td><td>No </td></tr>
<tr>
<td align="center">Pressure distribution </td><td>Yes </td></tr>
<tr>
<td align="center">Reduce vibraions </td><td>debatable </td></tr>
</table>
</center><h2>Skyhook controller</h2>
<p>The skyhook controller can be seen as a P controller that cats on velocity changes. What it does is given an velocity on a part of the machine calculates a proportional signal that will counteract the velocity change.</p>
<p>This controller acts on the following parts on the machine</p>
<ul>
<li>Induvidual wheels</li>
<li>Avrage chassi velocity in height</li>
<li>Rotation velocity in pitch and roll</li>
</ul>
<p>In math it looks like this, output for wheel an wheel</p>
<p class="formulaDsp">
\begin{equation} u_i = C_{w} v_i + C_{c} v_{c} + C_{\theta} \dot\theta + C_{\varphi} \dot{\varphi} \tag{5} \end{equation}
</p>
<p>So in pratrice this sort of controllers only purpose in life is to make the ride a bit smoother and reducing fast velocity changes, dampening the vibrations. This sort of controller does not take leveling or group pressure into consideration in any way.</p>
<p>This sort of controller will be it self achieve the following, given that it is possible to act fast egnouth on the velocity's changes:</p>
<center> <b>Table 6: Skyhook control achivments</b> </center> <center> <table class="doxtable">
<tr>
<th align="center">Active dampening Goals </th><th>PID leveling  </th></tr>
<tr>
<td align="center">Leveling </td><td>No </td></tr>
<tr>
<td align="center">Pressure distribution </td><td>No </td></tr>
<tr>
<td align="center">Reduce vibraions </td><td>Probably </td></tr>
</table>
</center><h2>Sliding mode</h2>
<p>Sliding mode 1st order controlelr is a non linjar type of controller that is used to slide on a surface. In this application the sliding surface is the error of the force on the forwarder. So what it attempts to do is given a force reference is to drive this force error to zero.</p>
<p>In sliding mode you determine a srurace that the controller should slide along. When the surfce is reached (simga -&gt; 0) the equial controll will keep it there. In this application when controlling the pos of the forwarder wheel the output u is going to be zero when sigma is sero thus there is no equial controll. This could make the controller realy simel to implement. A great introduction page to sliding mode is found in in the case sigma -&gt; 0 -&gt; u -&gt; 0 for t-&gt; inf <a href="http://www.diee.unica.it/~eusai/BOSIO/A%20QUICK%20INTRODUCTION%20TO%20SLIDING%20MODE%20CONTROL.pdf">Sliding mode intro</a>.</p>
<p>A summery of sliding mode is</p>
<p class="formulaDsp">
\begin{align} \sigma &amp; = \dot{e} + K \cdot e \tag{10} \\ u &amp; = K_{sm} \frac{\sigma}{abs{\sigma} + \epsilon} \tag{7} \end{align}
</p>
<p>This approuch would drive the error to zero, with also having a continous signal. It can also easyely be turn into a 2nd order slidng mode controller by using the super twisting algorithm</p>
<p class="formulaDsp">
\begin{align} u &amp; = - \lambda \sqrt{ |\sigma |} sgn(\sigma) + w \\ \dot{w} &amp; = -W \cdot sgn(\sigma) \tag{7} \end{align}
</p>
<p>where the parameters are determend as</p>
<p class="formulaDsp">
\begin{align} \lambda &amp; = \sqrt(U) \\ W &amp; = 1.1 \cdot U \tag{7} \end{align}
</p>
<p>This is a one parameter design and can be seen as sliding modes variant of PI control. The output signal is also continuous.</p>
<h3>Implemented sliding mode</h3>
<p>The implemented sliding mode is based on <a href="https://www.kth.se/social/upload/507ff5cbf276547b13000002/Compendium_2012.pdf">KTH Non linear control</a> , lecture 9 slide 26.</p>
<p>The implementation math is described as follows. The sliding surface is defined as</p>
<p class="formulaDsp">
\begin{align} \sigma &amp; = e_{F} \tag{6} \\ S(\sigma) &amp; = \frac{\sigma}{abs(\sigma) + K_s} \tag{7} \end{align}
</p>
<p>As this is a first</p>
<p class="formulaDsp">
\begin{equation} \mathcal{L} = \begin{cases} A_A \cdot Q_{max} + \frac{A_B \cdot \sqrt{P_B} \cdot Q_{max}}{\Delta P} &amp; if &amp; u_{old} \geq 0 \\ A_B \cdot Q_{max} + \frac{A_A \cdot \sqrt{P_A} \cdot Q_{max}}{\Delta P} &amp; if &amp; u_{old} &lt; 0 \end{cases} \tag{8} \end{equation}
</p>
<p>gives the following control law</p>
<p class="formulaDsp">
\begin{equation} u_{flow} = \frac{1}{\mathcal{L}} \left( \dot{x_w}(A_A^2 + A_B^2) + K_{sm} \cdot S(\sigma) \right) \tag{9} \end{equation}
</p>
<p>The authors of this control law is Frank and Bruno. For further details on this implementation see their report at KTH.se. </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<div class="container col-sm-12">
            <!--eri-no-index-->
<div class="treebackleftcontainer hidden-print">
    <div class="treebackrel">
        <div class="treebottomback left">
        </div>
    </div>
</div>
<div class="treebackrightcontainer hidden-print">
    <div class="treebackrel">
        <div class="treebottomback right flip">
        </div>
    </div>
</div>
<!--/eri-no-index-->
        </div>
<br>
<br>
<br>
<br>
<footer class="hidden-print">
    <div class="container">
        <div class="row" style="">
                <div class="col-sm-4 col-xxs-6">
                    <h2 class="alt">Navigation</h2>
<ul class="fa-ul">
     	<li><i class="fa-li fa fa-angle-right"></i>
            <a href="./index.html">Main Page </a> 
        </li>
        <li><i class="fa-li fa fa-angle-right"></i>
            <a href="./modules.html">Moduels </a> 
        </li>
        <li><i class="fa-li fa fa-angle-right"></i>
            <a href="./ADCONFIG.html">Configurations </a> 
        </li>
        <li><i class="fa-li fa fa-angle-right"></i>
            <a href="./ADCONTROLLERS.html">Controllers </a> 
        </li>
</ul>
                </div>
                <div id="external" class="col-sm-4 col-xxs-6">
                    <h2 class="alt">Partners</h2>
<ul class="fa-ul">
        <li><i class="fa-li fa fa-tree"></i>
            <a href="http://www.skogforsk.se/" target="_blank" title="Skogforsk">Skogforsk</a> 
        </li>
         <li><i class="fa-li fa fa-child"></i>
            <a href="http://www.keyo.se/" target="_blank" title="Keyo Systems AB">Keyo Systems AB</a> 
        </li>
        <li><i class="fa-li fa fa-university"></i>
            <a href="http://www.kth.se/" target="_blank" title="royal institute of technology">Royal institute of technology</a> 
        </li>
</ul>
                </div>
                <div class="col-sm-4 col-xxs-6">
                    <h2 class="alt">Contact</h2>
                    <div><i class="fa fa-phone"></i><a href="tel:+46 73 440 34 92"> +46 73 440 34 92</a></div>
                    <a href="mailto: johanhm@kth.se"><i class="fa fa-envelope"></i>&nbsp;&nbsp;johanhm@kth.se</a>
                    <br>
                </div>
        </div>
    </div>
</footer>
</body>
</html>